/*! Medianth Tracker v1.0.0 | (c) 2026 Medianth */
var MedianthTracker=function(t){"use strict";const e="[Medianth] ",i={attentionViewport:{topExclusion:.15,bottomExclusion:.15},visibilityThreshold:.5,contemplationTime:800,renderThrottle:1e3,scrollThrottle:100,mutationDebounce:300,inactivityTimeout:{mobile:2e4,desktop:3e4},desktopCursorEngagementTime:3e3,performanceMode:!0},n={normalizeProductUrl(t){try{if(!t)return null;const e=new URL(t,window.location.origin),i=e.pathname.match(/\/products\/([^\/\?#]+)/);if(!i)return null;const n=`/products/${i[1]}`,o=e.searchParams.get("variant");return o?`${n}?variant=${o}`:n}catch(t){return null}},throttle(t,e){let i=null,n=0;return function(...o){const s=Date.now(),r=e-(s-n);r<=0||r>e?(null!==i&&(clearTimeout(i),i=null),n=s,t.apply(this,o)):null===i&&(i=window.setTimeout(()=>{n=Date.now(),i=null,t.apply(this,o)},r))}},debounce(t,e){let i;return function(...n){void 0!==i&&clearTimeout(i),i=window.setTimeout(()=>{t.apply(this,n)},e)}},isMobile:()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window,getBoundingRect:t=>t.getBoundingClientRect(),isInHorizontalScroller(t){let e=t.parentElement;for(;e;){const t=window.getComputedStyle(e).overflowX;if(("scroll"===t||"auto"===t)&&e.scrollWidth>e.clientWidth)return e;e=e.parentElement}return null}};class o{attentionViewport=this.calculateAttentionViewport();scrollDirection="down";lastScrollY=window.scrollY;hasUserScrolled=!1;isPaused=!1;lastActivityTime=Date.now();inactivityTimer=null;isMobile=n.isMobile();cursorEnteredTime=null;cursorInPage=!1;constructor(){}calculateAttentionViewport(){const t=window.innerHeight;return{top:t*i.attentionViewport.topExclusion,bottom:t*(1-i.attentionViewport.bottomExclusion),height:t*(1-i.attentionViewport.topExclusion-i.attentionViewport.bottomExclusion)}}updateViewportOnResize(){const t=n.throttle(()=>{this.attentionViewport=this.calculateAttentionViewport()},250);window.addEventListener("resize",t)}setupScrollDirectionTracking(){const t=n.throttle(()=>{const t=window.scrollY;this.hasUserScrolled||t===this.lastScrollY||(this.hasUserScrolled=!0),t>this.lastScrollY?this.scrollDirection="down":t<this.lastScrollY&&(this.scrollDirection="up"),this.lastScrollY=t},50);window.addEventListener("scroll",t,{passive:!0})}setupInactivityDetection(){const t=this.isMobile?i.inactivityTimeout.mobile:i.inactivityTimeout.desktop,e=()=>{this.lastActivityTime=Date.now(),this.isPaused&&(this.isPaused=!1),this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(()=>{this.isPaused=!0},t)};this.isMobile?(window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("touchstart",e,{passive:!0}),window.addEventListener("touchmove",n.throttle(e,1e3),{passive:!0}),e()):(document.addEventListener("mouseenter",()=>{this.cursorInPage=!0,this.cursorEnteredTime=Date.now()}),document.addEventListener("mouseleave",()=>{this.cursorInPage=!1,this.cursorEnteredTime=null}),window.addEventListener("scroll",()=>{e(),this.hasUserScrolled=!0},{passive:!0}),setInterval(()=>{this.cursorInPage&&this.cursorEnteredTime&&Date.now()-this.cursorEnteredTime>=i.desktopCursorEngagementTime&&e()},1e3),window.addEventListener("mousedown",e,{passive:!0}),window.addEventListener("keydown",e,{passive:!0}),e())}calculateVisibility(t){if(!this.hasUserScrolled)return 0;if(this.isPaused)return 0;const{image:e,horizontalContainer:i}=t,o=n.getBoundingRect(e),s=this.attentionViewport;if(i){const t=n.getBoundingRect(i),e=this.calculateHorizontalVisibility(o,t);if(0===e)return 0;const r=this.calculateVerticalVisibility(o,s);return Math.min(e,r)}return this.calculateVerticalVisibilityDirectional(o,s)}calculateVerticalVisibilityDirectional(t,e){const n=t.top,o=t.bottom,s=t.height,r=n+s/2;if(o<=e.top)return 0;if(n>=e.bottom)return 0;const a=Math.max(n,e.top),l=(Math.min(o,e.bottom)-a)/s;if(l<i.visibilityThreshold)return 0;if("down"===this.scrollDirection){if(!(n>=e.top&&n<=e.bottom||r>=e.top&&r<=e.bottom))return 0}else if("up"===this.scrollDirection&&!(o>=e.top&&o<=e.bottom||r>=e.top&&r<=e.bottom))return 0;return Math.max(0,Math.min(1,l))}calculateVerticalVisibility(t,e){const i=t.top,n=t.bottom,o=t.height;if(n<=e.top)return 0;if(i>=e.bottom)return 0;const s=Math.max(i,e.top),r=Math.min(n,e.bottom)-s;return Math.max(0,Math.min(1,r/o))}calculateHorizontalVisibility(t,e){const i=t.left,n=t.right,o=t.width,s=e.left,r=e.right;if(n<=s)return 0;if(i>=r)return 0;const a=Math.max(i,s),l=Math.min(n,r)-a;return Math.max(0,Math.min(1,l/o))}isVisible(t){return this.calculateVisibility(t)>=i.visibilityThreshold}}class s{visibilityEngine;attentionState;constructor(){this.visibilityEngine=new o,this.attentionState=new Map}update(t){const e=Date.now(),n=new Set;if(this.visibilityEngine.isPaused)for(const[t,e]of this.attentionState.entries())e.isVisible&&e.dwellStartTime&&(e.totalDwellTime+=e.currentSessionDwell,e.currentSessionDwell=0,e.dwellStartTime=null,e.isContemplating=!1),e.isVisible=!1;else{t.forEach(t=>{const{url:o}=t,s=this.visibilityEngine.calculateVisibility(t),r=s>=i.visibilityThreshold;let a=this.attentionState.get(o);a||(a={url:o,visibility:0,isVisible:!1,dwellStartTime:null,totalDwellTime:0,currentSessionDwell:0,isContemplating:!1,wasContemplated:!1,viewCount:0,lastVisibilityChange:e,firstSeen:e,product:t},this.attentionState.set(o,a));const l=a.isVisible;a.visibility=s,a.isVisible=r,r?(n.add(o),l||(a.dwellStartTime=e,a.currentSessionDwell=0,a.viewCount++,a.lastVisibilityChange=e),a.dwellStartTime&&(a.currentSessionDwell=e-a.dwellStartTime,a.currentSessionDwell>=i.contemplationTime&&!a.isContemplating&&(a.isContemplating=!0,a.wasContemplated=!0))):l&&a.dwellStartTime&&(a.totalDwellTime+=a.currentSessionDwell,a.currentSessionDwell=0,a.dwellStartTime=null,a.isContemplating=!1,a.lastVisibilityChange=e)});for(const[t,i]of this.attentionState.entries())if(!n.has(t)&&i.isVisible){if(i.dwellStartTime){const t=e-i.dwellStartTime;i.totalDwellTime+=t}i.isVisible=!1,i.isContemplating=!1,i.dwellStartTime=null,i.lastVisibilityChange=e}}}getContemplatingProducts(){return Array.from(this.attentionState.values()).filter(t=>t.isContemplating)}getAllAttentionData(){return Array.from(this.attentionState.values())}getProductState(t){return this.attentionState.get(t)}reset(){this.attentionState.clear()}}let r=class{attentionEngine;debugPanel=null;viewportOverlay=null;constructor(t){this.attentionEngine=t}initDebugPanel(){this.viewportOverlay=document.createElement("div"),this.viewportOverlay.id="shopify-attention-viewport-overlay",this.viewportOverlay.style.cssText="\n            position: fixed;\n            left: 0;\n            right: 0;\n            background: rgba(255, 0, 0, 0.15);\n            border-top: 3px solid rgba(255, 0, 0, 0.8);\n            border-bottom: 3px solid rgba(255, 0, 0, 0.8);\n            pointer-events: none;\n            z-index: 2147483647;\n            transition: top 0.1s, height 0.1s;\n        ";const t=this.attentionEngine.visibilityEngine.attentionViewport;this.viewportOverlay.style.top=`${t.top}px`,this.viewportOverlay.style.height=`${t.height}px`,document.body.insertBefore(this.viewportOverlay,document.body.firstChild),window.addEventListener("resize",()=>{const t=this.attentionEngine.visibilityEngine.attentionViewport;this.viewportOverlay.style.top=`${t.top}px`,this.viewportOverlay.style.height=`${t.height}px`}),this.debugPanel=document.createElement("div"),this.debugPanel.id="shopify-attention-tracker-debug",this.debugPanel.style.cssText='\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            width: 350px;\n            max-height: 80vh;\n            overflow-y: auto;\n            background: rgba(0, 0, 0, 0.95);\n            color: #00ff00;\n            font-family: "Courier New", monospace;\n            font-size: 12px;\n            padding: 15px;\n            border-radius: 8px;\n            z-index: 2147483646;\n            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);\n            border: 2px solid #00ff00;\n        ',document.body.insertBefore(this.debugPanel,document.body.firstChild);const e=document.createElement("button");e.textContent="√ó",e.style.cssText="\n            position: absolute;\n            top: 5px;\n            right: 10px;\n            background: none;\n            border: none;\n            color: #00ff00;\n            font-size: 24px;\n            cursor: pointer;\n            padding: 0;\n            line-height: 1;\n        ",e.onclick=()=>this.hideDebugPanel(),this.debugPanel.appendChild(e)}render(){this.debugPanel||this.initDebugPanel();const t=this.attentionEngine.getContemplatingProducts(),e=this.attentionEngine.getAllAttentionData(),n=this.attentionEngine.visibilityEngine.scrollDirection.toUpperCase(),o="DOWN"===n?"‚Üì":"‚Üë",s=this.attentionEngine.visibilityEngine.hasUserScrolled,r=this.attentionEngine.visibilityEngine.isPaused;let a,l;s?r?(a="‚è∏Ô∏è PAUSED (inactive)",l="#ff6b6b"):(a=`Scroll: ${o} ${n}`,l="#0f0"):(a="‚è∏Ô∏è Waiting for scroll...",l="#888");let c=`\n            <h3 style="margin: 0 0 15px 0; color: #00ff00; border-bottom: 2px solid #00ff00; padding-bottom: 10px;">\n            üìä ATTENTION TRACKER\n            </h3>\n            <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 0, 0.1); border-radius: 4px;">\n            <strong>Currently Contemplating: ${t.length}</strong><br>\n            <span style="color: #888;">Total Tracked: ${e.length}</span><br>\n            <span style="color: ${l}; font-weight: bold;">\n                ${a}\n            </span>\n            </div>\n        `;0===t.length?c+='<p style="color: #888; font-style: italic;">No products being contemplated...</p>':t.forEach((t,e)=>{const i=t.currentSessionDwell||0,n=t.totalDwellTime+i;c+=`\n                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 0, 0.15); border-left: 3px solid #00ff00; border-radius: 4px;">\n                    <div style="font-weight: bold; margin-bottom: 5px; color: #00ff00;">\n                        üéØ Product ${e+1}\n                    </div>\n                    <div style="font-size: 10px; color: #0f0; margin-bottom: 8px; word-break: break-all;">\n                        ${t.url}\n                    </div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px;">\n                        <div><span style="color: #888;">Visibility:</span> ${(100*t.visibility).toFixed(0)}%</div>\n                        <div><span style="color: #888;">Views:</span> ${t.viewCount}</div>\n                        <div><span style="color: #888;">Total:</span> ${(n/1e3).toFixed(1)}s</div>\n                        <div><span style="color: #888;">Session:</span> ${(i/1e3).toFixed(1)}s</div>\n                    </div>\n                    </div>\n                `});const d=e.filter(t=>t.isVisible).length,u=e.filter(t=>t.wasContemplated).length;c+=`\n            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #00ff00; font-size: 11px; color: #888;">\n            <div>Visible Now: ${d}</div>\n            <div>Total Contemplated (session): ${u}</div>\n            <div>Viewport: ${100*i.attentionViewport.topExclusion}%-${100*(1-i.attentionViewport.bottomExclusion)}%</div>\n            </div>\n        `,this.debugPanel.innerHTML=c;const h=document.createElement("button");h.textContent="√ó",h.style.cssText="\n            position: absolute;\n            top: 5px;\n            right: 10px;\n            background: none;\n            border: none;\n            color: #00ff00;\n            font-size: 24px;\n            cursor: pointer;\n            padding: 0;\n            line-height: 1;\n        ",h.onclick=()=>this.hideDebugPanel(),this.debugPanel.appendChild(h)}showDebugPanel(){this.debugPanel&&(this.debugPanel.style.display="block"),this.viewportOverlay&&(this.viewportOverlay.style.display="block")}hideDebugPanel(){this.debugPanel&&(this.debugPanel.style.display="none"),this.viewportOverlay&&(this.viewportOverlay.style.display="none")}destroy(){this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.viewportOverlay&&(this.viewportOverlay.remove(),this.viewportOverlay=null)}};function a(t){if(Array.isArray(t)){const e=t.map(a).filter(t=>void 0!==t);return e.length>0?e:void 0}return t&&"object"==typeof t?Object.fromEntries(Object.entries(t).map(([t,e])=>[t,a(e)]).filter(([,t])=>!(null==t||"string"==typeof t&&""===t.trim()||"number"==typeof t&&Number.isNaN(t)||Array.isArray(t)&&0===t.length))):null==t||"string"==typeof t&&""===t.trim()||"number"==typeof t&&Number.isNaN(t)?void 0:t}const l=(t,e)=>{if(!e.includes(t[0]))return null;const i=t[1];return i?decodeURIComponent(i).replace(/[-_]/g," "):null};function c(t){if(!t)return{url:void 0,urlPaths:void 0,urlParamsAll:void 0,urlIsProductPage:void 0,urlIsCollectionPage:void 0,productName:void 0,collectionName:void 0};const e=new URL(t),i=e.pathname.split("/").filter(Boolean),n=Array.from(e.searchParams.entries()).map(([t,e])=>({key:t,value:e}));return{url:e,urlPaths:i,urlParamsAll:n,urlIsProductPage:"product"===i[0]||"products"===i[0],urlIsCollectionPage:"collection"===i[0]||"collections"===i[0],productName:l(i,["product","products"])??void 0,collectionName:l(i,["collection","collections"])??void 0}}class d{isRunning;updateInterval;renderInterval;productDetector;attentionEngine;debugPanel;constructor(t){this.productDetector=t,this.attentionEngine=new s,this.debugPanel=new r(this.attentionEngine),this.isRunning=!1,this.updateInterval=null,this.renderInterval=null}start(){if(this.isRunning)return console.warn(e+"Attention Detector is already running!"),this;console.log(e+"üéØ Starting Attention Detector..."),this.productDetector.init(),this.attentionEngine.visibilityEngine.updateViewportOnResize(),this.attentionEngine.visibilityEngine.setupScrollDirectionTracking(),this.attentionEngine.visibilityEngine.setupInactivityDetection(),this.updateInterval=setInterval(()=>{const t=this.productDetector.getAllProducts();this.attentionEngine.update(t),this.productDetector.cleanupStaleProducts()},i.scrollThrottle),this.renderInterval=setInterval(()=>{this.debugPanel.render()},i.renderThrottle),this.debugPanel.render();const t=n.throttle(()=>{const t=this.productDetector.getAllProducts();this.attentionEngine.update(t)},i.scrollThrottle);return window.addEventListener("scroll",t,{passive:!0}),document.addEventListener("scroll",t,{passive:!0,capture:!0}),this.isRunning=!0,console.log(e+"‚úÖ Attention Detector started successfully"),console.log(e+"üìä Debug panel visible in top-right corner"),this}stop(){return this.isRunning?(console.log(e+"‚è∏Ô∏è Attention Detector stopping..."),this.updateInterval&&clearInterval(this.updateInterval),this.renderInterval&&clearInterval(this.renderInterval),this.isRunning=!1,console.log(e+"‚úÖ Attention Detector stopped"),this):this}exportData(){return{timestamp:Date.now(),contemplating:this.attentionEngine.getContemplatingProducts().map(t=>({url:t.url,visibility:t.visibility,totalDwellTime:t.totalDwellTime+(t.dwellStartTime?Date.now()-t.dwellStartTime:0),viewCount:t.viewCount,firstSeen:t.firstSeen})),allProducts:this.attentionEngine.getAllAttentionData().map(t=>({url:t.url,wasContemplated:t.wasContemplated,totalDwellTime:t.totalDwellTime,viewCount:t.viewCount,firstSeen:t.firstSeen,lastVisibilityChange:t.lastVisibilityChange}))}}exportSnapshotData(){return this.attentionEngine.getAllAttentionData().filter(t=>t.viewCount>0&&t.totalDwellTime>0).map(t=>{const e=new URL(t.url,window.location.origin),i=e.pathname.split("/").filter(Boolean),n=l(i,["product","products"]);return{is_variant:e.searchParams.has("variant"),url_full:e.href,url_paths:e.pathname,url_path_full:t.url,url_parameters_product_variant:e.searchParams.get("variant"),url_path_product_name:n,first_seen:t.firstSeen,last_seen:t.lastVisibilityChange,view_count:t.viewCount,total_dwell_time:t.totalDwellTime}})}getContemplating(){return this.attentionEngine.getContemplatingProducts()}showDebug(){this.debugPanel.showDebugPanel()}hideDebug(){this.debugPanel.hideDebugPanel()}reset(){return this.attentionEngine.reset(),console.log(e+"üîÑ Attention Detector data reset."),this}destroy(){this.stop(),this.productDetector.destroy(),this.debugPanel.destroy(),console.log(e+"üí• Attention Detector destroyed")}updateConfig(t){return Object.assign(i,t),console.log(e+"‚öôÔ∏è Attention Detector config updated: ",t),this}}class u{products;observer;constructor(){this.products=new Map,this.observer=null}init(){return this.scanForProducts(),this.observeDOMMutations(),this}scanForProducts(){document.querySelectorAll('a[href*="/products/"]').forEach(t=>{const e=t.getAttribute("href"),i=n.normalizeProductUrl(e);if(!i)return;const o=t.querySelectorAll("img");let s=null;for(const t of o){const e=window.getComputedStyle(t);if("none"!==e.display&&"hidden"!==e.visibility&&"0"!==e.opacity){s=t;break}}s&&(this.products.has(i)||this.products.set(i,{url:i,element:t,image:s,lastSeen:Date.now(),horizontalContainer:n.isInHorizontalScroller(t)}))})}observeDOMMutations(){const t=n.debounce(()=>{this.scanForProducts()},i.mutationDebounce);this.observer=new MutationObserver(e=>{let i=!1;for(const t of e)if(t.addedNodes.length>0||t.removedNodes.length>0){i=!0;break}i&&t()}),this.observer.observe(document.body,{childList:!0,subtree:!0})}cleanupStaleProducts(){const t=Date.now();for(const[e,i]of this.products.entries())document.body.contains(i.element)?i.lastSeen=t:t-i.lastSeen>5e3&&this.products.delete(e)}getAllProducts(){return Array.from(this.products.values())}getAllProductsCount(){return this.products.size}destroy(){this.observer&&this.observer.disconnect(),this.products.clear()}}class h{constructor(){}setCookie(t,e,i={}){if("undefined"==typeof document)return;const{maxAgeSeconds:n,path:o="/",domain:s,secure:r=!0,sameSite:a="strict"}=i;let l=`${encodeURIComponent(t)}=${encodeURIComponent(e)}`;null!=n&&(l+=`; max-age=${n}`),o&&(l+=`; path=${o}`),s&&(l+=`; domain=${s}`),r&&(l+="; secure"),a&&(l+=`; samesite=${a}`),document.cookie=l}getCookie(t){const e=document.cookie.split("; ").find(e=>e.startsWith(t+"="));return e?decodeURIComponent(e.split("=").slice(1).join("=")):null}}class p{organizationID;avatarID;sessionID;sessionStartTime;constructor(t,e){this.organizationID=t,this.avatarID=e,this.sessionID=this.getSessionID(),this.sessionStartTime=Date.now()}getSessionID(){const t=`medianth_session_${this.organizationID}_${this.avatarID}`;let e=sessionStorage.getItem(t);return e||(e=this.generateSessionID(),sessionStorage.setItem(t,e)),e}generateSessionID(){return`${Date.now()}-${Math.random().toString(36).substring(2,11)}`}getSessionDuration(){return Date.now()-this.sessionStartTime}renewSession(){this.sessionID=this.generateSessionID(),this.sessionStartTime=Date.now();const t=`medianth_session_${this.organizationID}_${this.avatarID}`;sessionStorage.setItem(t,this.sessionID)}}class g{sessionManager;productDetector;attentionDetector;constructor(t,e,i){this.sessionManager=t,this.productDetector=e,this.attentionDetector=i}buildPageSnapshot(){const{url:t,urlPaths:e,urlParamsAll:i,urlIsProductPage:n,urlIsCollectionPage:o,productName:s,collectionName:r}=c(window.location.href),{url:l,urlPaths:d,urlParamsAll:u,urlIsProductPage:h,urlIsCollectionPage:p,productName:g,collectionName:m}=c(document.referrer),b=new Set(["utm_source","utm_medium","utm_campaign","utm_term","utm_content"]),v=new Set(["gclid","gclsrc","dclid","wbraid","gbraid","fbclid","msclkid","twclid","li_fat_id","mc_cid","igshid","ttclid"]);return a({session_id:this.sessionManager.sessionID,organization_id:this.sessionManager.organizationID,avatar_id:this.sessionManager.avatarID,snapshot_timestamp:Date.now(),title:document.title,viewport_width:window.innerWidth,viewport_height:window.innerHeight,user_agent:navigator.userAgent,is_product_page:n,is_product_variant:t&&t.searchParams.has("variant"),is_collection_page:o,referrer_is_product_page:h,referrer_is_product_variant:l&&l.searchParams.has("variant"),referrer_is_same_product_page_but_different_variant:l&&t&&l.pathname===t.pathname&&l.searchParams.get("variant")!==t.searchParams.get("variant"),referrer_is_collection_page:p,referrer_url_full:l&&l.href,referrer_url_origin:l&&l.origin,referrer_url_protocol:l&&l.protocol,referrer_url_hostname:l&&l.hostname,referrer_url_path_full:l&&l.pathname,referrer_url_path_all:d,referrer_url_parameters_all:u,referrer_url_parameters_utm:u&&u.filter(t=>b.has(t.key)),referrer_url_parameters_ads:u&&u.filter(t=>v.has(t.key)),referrer_url_parameters_product_variant:l&&(l.searchParams.get("variant")??void 0),referrer_url_path_product_name:g,referrer_url_path_collection_name:m,url_full:t&&t.href,url_origin:t&&t.origin,url_protocol:t&&t.protocol,url_hostname:t&&t.hostname,url_path_full:t&&t.pathname,url_path_all:e,url_parameters_all:i,url_parameters_utm:i&&i.filter(t=>b.has(t.key)),url_parameters_ads:i&&i.filter(t=>v.has(t.key)),url_parameters_product_variant:t&&(t.searchParams.get("variant")??void 0),url_path_product_name:s,url_path_collection_name:r,product_detector_total_products:this.productDetector.getAllProductsCount()})}buildSessionSnapshot(){return a({session_id:this.sessionManager.sessionID,organization_id:this.sessionManager.organizationID,avatar_id:this.sessionManager.avatarID,snapshot_timestamp:Date.now(),session_duration:this.sessionManager.getSessionDuration(),session_start_time:this.sessionManager.sessionStartTime,attention_detector_products:this.attentionDetector.exportSnapshotData()})}}class m{collectorUrl;retryQueue=[];maxRetries=3;constructor(t){this.collectorUrl=t}async sendData(t,i){try{if(navigator.sendBeacon&&"session_snapshot"===i){const e=new Blob([JSON.stringify(t)],{type:"application/json"});if(!navigator.sendBeacon(this.collectorUrl,e))throw new Error("sendBeacon failed")}else{const e=await fetch(this.collectorUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0});if(!e.ok)throw new Error(`HTTP ${e.status}`)}}catch(i){console.error(e+"Failed to send snapshot: ",i),this.queueForRetry(t)}}async sendPageSnapshot(t){const e={token:document.cookie.match(new RegExp("(^| )medianthJWTToken=([^;]+)")),topic:"PAGE_SNAPSHOT",message:JSON.stringify(t)};await this.sendData(e,"page_snapshot")}async sendSessionSnapshot(t){const e={token:document.cookie.match(new RegExp("(^| )medianthJWTToken=([^;]+)")),topic:"SESSION_SNAPSHOT",message:JSON.stringify(t)};await this.sendData(e,"session_snapshot")}queueForRetry(t){this.retryQueue.push({data:t,retries:0}),this.processRetryQueue()}async processRetryQueue(){if(0===this.retryQueue.length)return;const t=this.retryQueue.shift();if(t)if(t.retries>=this.maxRetries)console.error(e+"Max retries reached, dropping event.");else try{console.warn(e+"Retrying to send snapshot... ("+(t.retries+1)+")");const i=await fetch(this.collectorUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t.data),keepalive:!0});if(!i.ok)throw new Error(`HTTP ${i.status}`)}catch(e){t.retries++,this.retryQueue.push(t),setTimeout(()=>{this.processRetryQueue()},1e3*Math.pow(2,t.retries))}}flushQueue(){for(;this.retryQueue.length>0;)this.processRetryQueue()}}class b{initialized=!1;transport;config;jwtToken="";sessionManager;snapshotBuilder;cookieManager;productDetector;attentionDetector;constructor(t){this.config=t,this.validateConfig(),this.cookieManager=new h,this.sessionManager=new p(t.organizationID,t.avatarID),this.productDetector=new u,this.attentionDetector=new d(this.productDetector),this.snapshotBuilder=new g(this.sessionManager,this.productDetector,this.attentionDetector),this.transport=new m(t.collectorUrl),this.initialize(t)}validateConfig(){if(!this.config.organizationID)throw new Error(e+"organizationID is required");if(!this.config.avatarID)throw new Error(e+"avatarID is required");if(!this.config.collectorUrl)throw new Error(e+"collectorUrl is required")}async initialize(t){this.initialized||(this.attentionDetector.start(),this.initialized=!0,this.config.debug&&console.log(e+"Tracker initialized",{organizationID:this.config.organizationID,avatarID:this.config.avatarID,sessionID:this.sessionManager.sessionID}))}attachUnloadListeners(){window.addEventListener("beforeunload",()=>{this.handleUnload()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.handleUnload()}),window.addEventListener("pagehide",()=>{this.handleUnload()})}handleUnload(){this.config.debug&&console.log(e+"Sending session snapshot on unload...");const t=this.snapshotBuilder.buildSessionSnapshot();this.transport.sendSessionSnapshot(t),this.transport.flushQueue()}sendPageSnapshot(){const t=this.snapshotBuilder.buildPageSnapshot();this.transport.sendPageSnapshot(t)}reInitialize(){this.config.debug&&console.warn(e+"Reinitializing..."),this.handleUnload(),this.sessionManager.renewSession(),this.sendPageSnapshot()}destroy(){this.config.debug&&console.warn(e+"Destroying tracker..."),this.handleUnload(),this.initialized=!1}debugSessionSnapshot(){if(!this.config.debug)return;const t=this.snapshotBuilder.buildSessionSnapshot();console.log(e+"Session Snapshot: ",t)}debugPageSnapshot(){if(!this.config.debug)return;const t=this.snapshotBuilder.buildPageSnapshot();console.log(e+"Page Snapshot: ",t)}debugJWTToken(){this.config.debug&&(console.log(e+"JWT Token string: "+this.jwtToken),console.log(e+"JWT Token cookie: "+this.cookieManager.getCookie("medianthJWTToken")))}}class v{debugPanel=null;tracker;constructor(t){this.tracker=t}initDebugPanel(){this.debugPanel=document.createElement("div"),this.debugPanel.id="medianth-debug-buttons",this.debugPanel.style.cssText="\n            position: fixed;\n            left: 0;\n            bottom: 0;\n        ",document.body.insertBefore(this.debugPanel,document.body.firstChild);const t=document.createElement("button");t.textContent="Snapshot: Page",t.onclick=()=>this.tracker.debugPageSnapshot(),this.debugPanel.appendChild(t);const e=document.createElement("button");e.textContent="Snapshot: Session",e.onclick=()=>this.tracker.debugSessionSnapshot(),this.debugPanel.appendChild(e)}showDebugPanel(){this.debugPanel&&(this.debugPanel.style.display="block")}hideDebugPanel(){this.debugPanel&&(this.debugPanel.style.display="none")}destroy(){this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null)}}let w=null;const f=document.currentScript;function y(){const t=f;if(!t)return void console.error(e+"Could not find script tag");const i=t.getAttribute("measurementID")?.slice(0,8),n=t.getAttribute("measurementID")?.slice(9,17);if(!i||!n)return void console.error(e+"Missing required attribute: measurementID");const o="?id="+i+"_"+n,s="http://localhost:3000/v1/tracker/init"+o,r="http://localhost:3000/v1/tracker/collector"+o,a="true"===t.getAttribute("debug"),l={organizationID:i,avatarID:n,initUrl:s,collectorUrl:r,debug:a};try{w=new b(l),window.medianth.tracker=w,a&&new v(w).initDebugPanel()}catch(t){console.error(e+"Initialization failed: ",t)}}return"undefined"!=typeof window&&(window.medianth={tracker:null,reInitialize:()=>w?.reInitialize(),destroy:()=>w?.destroy(),debugSessionSnapshot:()=>w?.debugSessionSnapshot(),debugPageSnapshot:()=>w?.debugPageSnapshot(),debugJWTToken:()=>w?.debugJWTToken()}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",y):y(),t.MedianthTracker=b,t.consoleIcon=e,t}({});
