/*! Medianth Tracker v1.0.0 | (c) 2026 Medianth */
var MedianthTracker=function(e){"use strict";const t="[Medianth] ",i={attentionViewport:{topExclusion:.15,bottomExclusion:.15},visibilityThreshold:.5,visibilityDropGraceMs:450,contemplationTime:800,renderThrottle:1e3,scrollThrottle:100,mutationDebounce:300,inactivityTimeout:{mobile:15e3,desktop:15e3},desktopCursorEngagementTime:3e3,performanceMode:!0},s={normalizeProductUrl(e){try{if(!e)return null;const t=new URL(e,window.location.origin),i=t.pathname.match(/^(\/(?:[^\/]+\/)?products\/[^\/\?#]+)/i);if(!i)return null;const s=i[1],n=t.searchParams.get("variant");return n?`${s}?variant=${n}`:s}catch(e){return null}},throttle(e,t){let i=null,s=0;return function(...n){const r=Date.now(),o=t-(r-s);o<=0||o>t?(null!==i&&(clearTimeout(i),i=null),s=r,e.apply(this,n)):null===i&&(i=window.setTimeout(()=>{s=Date.now(),i=null,e.apply(this,n)},o))}},debounce(e,t){let i;return function(...s){void 0!==i&&clearTimeout(i),i=window.setTimeout(()=>{e.apply(this,s)},t)}},isMobile:()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768||"ontouchstart"in window,getBoundingRect:e=>e.getBoundingClientRect(),isElementEffectivelyVisible(e){if(!e||!e.isConnected)return!1;const t=e.getBoundingClientRect();if(t.width<=0||t.height<=0||0===e.getClientRects().length)return!1;let i=e;for(;i;){if(i instanceof HTMLElement&&i.hidden)return!1;if("true"===i.getAttribute("aria-hidden"))return!1;const e=window.getComputedStyle(i);if("none"===e.display||"hidden"===e.visibility||"collapse"===e.visibility)return!1;if(parseFloat(e.opacity||"1")<=0)return!1;i=i.parentElement}return!0}};class n{attentionViewport=this.calculateAttentionViewport();scrollDirection="down";lastScrollY=window.scrollY;hasUserScrolled=!1;hasUserEngaged=!1;isPaused=!1;lastActivityTime=Date.now();inactivityTimer=null;cursorEngagementTimer=null;isMobile=s.isMobile();cursorInPage=!1;intersectionObserver=null;visibilityMap=new Map;observedTargets=new Map;constructor(){this.setupIntersectionObserver()}isBackgrounded(){return document.hidden||!document.hasFocus()}setPausedState(e){this.isPaused=e}markUserEngaged(e=!1){this.hasUserEngaged=!0,this.lastActivityTime=Date.now(),e?document.hidden||this.setPausedState(!1):this.isBackgrounded()||this.setPausedState(!1),this.updateInactivityTimer()}updateInactivityTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer);const e=this.isMobile?i.inactivityTimeout.mobile:i.inactivityTimeout.desktop;this.inactivityTimer=window.setTimeout(()=>{this.setPausedState(!0)},e)}setupIntersectionObserver(){const e=this.attentionViewport,t=-e.top,i=-(window.innerHeight-e.bottom);this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target.getAttribute("data-product-id");t&&(e.isIntersecting?this.visibilityMap.set(t,e.intersectionRatio):this.visibilityMap.set(t,0))})},{rootMargin:`${t}px 0px ${i}px 0px`,threshold:[0,.25,.5,.75,1]})}observeProduct(e){if(!this.intersectionObserver||!e.image)return;const t=this.observedTargets.get(e.id);t!==e.image&&(t&&this.intersectionObserver.unobserve(t),e.image.setAttribute("data-product-id",e.id),this.intersectionObserver.observe(e.image),this.observedTargets.set(e.id,e.image))}unobserveProduct(e){this.unobserveProductById(e.id)}unobserveProductById(e){if(!this.intersectionObserver)return;const t=this.observedTargets.get(e);t&&(this.intersectionObserver.unobserve(t),this.observedTargets.delete(e)),this.visibilityMap.delete(e)}calculateAttentionViewport(){const e=window.innerHeight;return{top:e*i.attentionViewport.topExclusion,bottom:e*(1-i.attentionViewport.bottomExclusion),height:e*(1-i.attentionViewport.topExclusion-i.attentionViewport.bottomExclusion)}}updateViewportOnResize(){const e=s.throttle(()=>{this.attentionViewport=this.calculateAttentionViewport(),this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.setupIntersectionObserver(),this.visibilityMap.clear(),this.observedTargets.clear())},250);window.addEventListener("resize",e)}setupScrollDirectionTracking(){const e=s.throttle(()=>{const e=window.scrollY;this.hasUserScrolled||e===this.lastScrollY||(this.hasUserScrolled=!0,this.markUserEngaged(!0)),e>this.lastScrollY?this.scrollDirection="down":e<this.lastScrollY&&(this.scrollDirection="up"),this.lastScrollY=e},50);window.addEventListener("scroll",e,{passive:!0})}setupInactivityDetection(){this.setPausedState(!0);const e=s.throttle(()=>{this.cursorInPage&&this.markUserEngaged(!0)},250),t=()=>{this.setPausedState(!0)},n=()=>{this.hasUserEngaged&&this.cursorInPage&&this.markUserEngaged()};this.isMobile?(window.addEventListener("touchstart",()=>this.markUserEngaged(),{passive:!0}),window.addEventListener("touchmove",s.throttle(()=>this.markUserEngaged(),500),{passive:!0})):(document.addEventListener("mouseenter",()=>{this.cursorInPage=!0,this.cursorEngagementTimer&&clearTimeout(this.cursorEngagementTimer),this.cursorEngagementTimer=window.setTimeout(()=>{this.cursorInPage&&this.markUserEngaged(!0)},i.desktopCursorEngagementTime)}),document.addEventListener("mouseleave",()=>{this.cursorInPage=!1,this.cursorEngagementTimer&&(clearTimeout(this.cursorEngagementTimer),this.cursorEngagementTimer=null),this.updateInactivityTimer()}),window.addEventListener("mousemove",e,{passive:!0}),window.addEventListener("wheel",()=>this.markUserEngaged(!0),{passive:!0}),window.addEventListener("mousedown",()=>this.markUserEngaged(),{passive:!0}),window.addEventListener("keydown",()=>this.markUserEngaged(),{passive:!0})),document.addEventListener("visibilitychange",()=>{document.hidden?t():n()}),window.addEventListener("blur",t),window.addEventListener("focus",n),this.updateInactivityTimer()}calculateVisibility(e){if(!this.hasUserEngaged)return 0;if(this.isPaused)return 0;if(!e.image||!s.isElementEffectivelyVisible(e.image)||!s.isElementEffectivelyVisible(e.element))return 0;const t=this.visibilityMap.get(e.id)||0;if(t>0){const t=s.getBoundingRect(e.image),i=this.attentionViewport,n=t.top,r=t.bottom,o=n+t.height/2;if("down"===this.scrollDirection){if(!(n>=i.top&&n<=i.bottom||o>=i.top&&o<=i.bottom))return 0}else if("up"===this.scrollDirection&&!(r>=i.top&&r<=i.bottom||o>=i.top&&o<=i.bottom))return 0}return t}isVisible(e){return this.calculateVisibility(e)>=i.visibilityThreshold}destroy(){this.intersectionObserver&&(this.intersectionObserver.disconnect(),this.intersectionObserver=null),this.visibilityMap.clear(),this.observedTargets.clear(),this.inactivityTimer&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=null),this.cursorEngagementTimer&&(clearTimeout(this.cursorEngagementTimer),this.cursorEngagementTimer=null)}}class r{visibilityEngine;attentionState;observedProductIds;constructor(){this.visibilityEngine=new n,this.attentionState=new Map,this.observedProductIds=new Set}update(e){const t=Date.now(),s=new Set,n=this.visibilityEngine.isPaused,r=new Set(e.map(e=>e.id));for(const t of e)this.visibilityEngine.observeProduct(t),this.observedProductIds.add(t.id);for(const e of this.observedProductIds)r.has(e)||(this.visibilityEngine.unobserveProductById(e),this.observedProductIds.delete(e));const o=new Map;for(const t of e){const e=this.visibilityEngine.calculateVisibility(t),s=e>=i.visibilityThreshold,n=o.get(t.url);(!n||e>n.visibility)&&o.set(t.url,{product:t,visibility:e,isVisible:s})}if(n)for(const[,e]of this.attentionState.entries())e.isVisible&&e.dwellStartTime&&(e.totalDwellTime+=e.currentSessionDwell,e.currentSessionDwell=0,e.dwellStartTime=null,e.isContemplating=!1),e.isVisible=!1,e.invisibleSince=null;else{o.forEach(({product:e,visibility:n,isVisible:r},o)=>{const a=o;let l=this.attentionState.get(a);l||(l={id:a,url:o,visibility:0,isVisible:!1,dwellStartTime:null,totalDwellTime:0,currentSessionDwell:0,isContemplating:!1,wasContemplated:!1,viewCount:0,lastVisibilityChange:t,firstSeen:t,invisibleSince:null,product:e},this.attentionState.set(a,l));const c=l.isVisible;if(l.url=e.url,l.product=e,l.visibility=n,l.isVisible=r,r)s.add(a),l.invisibleSince=null,c||(l.dwellStartTime=t,l.currentSessionDwell=0,l.viewCount++,l.lastVisibilityChange=t),l.dwellStartTime&&(l.currentSessionDwell=t-l.dwellStartTime,l.currentSessionDwell>=i.contemplationTime&&!l.isContemplating&&(l.isContemplating=!0,l.wasContemplated=!0));else if(c){if(null===l.invisibleSince&&(l.invisibleSince=t),t-l.invisibleSince<i.visibilityDropGraceMs)return s.add(a),l.isVisible=!0,void(l.dwellStartTime&&(l.currentSessionDwell=t-l.dwellStartTime));if(l.dwellStartTime){const e=l.invisibleSince;l.totalDwellTime+=Math.max(0,e-l.dwellStartTime)}l.currentSessionDwell=0,l.dwellStartTime=null,l.isContemplating=!1,l.isVisible=!1,l.lastVisibilityChange=t,l.invisibleSince=null}else l.invisibleSince=null});for(const[e,i]of this.attentionState.entries())if(!s.has(e)&&i.isVisible){if(i.dwellStartTime){const e=t-i.dwellStartTime;i.totalDwellTime+=e}i.isVisible=!1,i.isContemplating=!1,i.dwellStartTime=null,i.invisibleSince=null,i.lastVisibilityChange=t}}}getContemplatingProducts(){return Array.from(this.attentionState.values()).filter(e=>e.isContemplating)}getAllAttentionData(){return Array.from(this.attentionState.values())}getProductState(e){return this.attentionState.get(e)}reset(){for(const e of this.observedProductIds)this.visibilityEngine.unobserveProductById(e);this.observedProductIds.clear(),this.attentionState.clear()}destroy(){this.reset(),this.visibilityEngine.destroy()}}function o(e){if(Array.isArray(e)){const t=e.map(o).filter(e=>void 0!==e);return t.length>0?t:void 0}return e&&"object"==typeof e?Object.fromEntries(Object.entries(e).map(([e,t])=>[e,o(t)]).filter(([,e])=>!(null==e||"string"==typeof e&&""===e.trim()||"number"==typeof e&&Number.isNaN(e)||Array.isArray(e)&&0===e.length))):null==e||"string"==typeof e&&""===e.trim()||"number"==typeof e&&Number.isNaN(e)?void 0:e}const a=(e,t)=>{if(!e||e.length<2)return null;const i=e.length,s=e[i-2],n=e[i-1];return t.map(e=>e.toLowerCase()).includes(s.toLowerCase())&&n?decodeURIComponent(n).replace(/[-_]/g," "):null};function l(e){if(!e)return{url:void 0,urlPaths:void 0,urlParamsAll:void 0,urlIsProductPage:void 0,urlIsCollectionPage:void 0,productName:void 0,collectionName:void 0};const t=new URL(e),i=t.pathname.split("/").filter(Boolean),s=Array.from(t.searchParams.entries()).map(([e,t])=>({key:e,value:t}));return{url:t,urlPaths:i,urlParamsAll:s,urlIsProductPage:"products"===i[0]||"products"===i[1],urlIsCollectionPage:"collections"===i[0]||"collections"===i[1],productName:a(i,["products"])??void 0,collectionName:a(i,["collections"])??void 0}}const c=e=>/^(data:|blob:|https?:)/i.test(e)?e:e.startsWith("//")?`${window.location.protocol}${e}`:e.startsWith("/")?`${window.location.origin}${e}`:`${window.location.origin}/${e.replace(/^\.?\//,"")}`,d=(e,t={minW:200,maxW:600})=>{if(!e)return null;const{minW:i,maxW:s}=t,n=e.getAttribute("src"),r=e.getAttribute("srcset");if(!r){if(!n)return null;const e=c(n);return{lowQuality:e,mediumQuality:e,highQuality:e}}const o=r.split(",").map(e=>{const t=e.trim().split(/\s+/);return{url:t[0]?.replace(/&amp;/g,"&"),descriptor:t[1]??null}}).filter(e=>Boolean(e.url));if(0===o.length){if(!n)return null;const e=c(n);return{lowQuality:e,mediumQuality:e,highQuality:e}}const a=o.map(e=>({url:e.url,w:e.descriptor?.endsWith("w")?parseInt(e.descriptor,10):null})).filter(e=>null!==e.w);let l=null;if(a.length>0){const e=a.filter(e=>e.w>=i&&e.w<=s);e.length>0?l=c(e.sort((e,t)=>t.w-e.w)[0].url):a.every(e=>e.w<i)?l=c(a.sort((e,t)=>t.w-e.w)[0].url):a.every(e=>e.w>s)&&(l=c(a.sort((e,t)=>e.w-t.w)[0].url))}const d=a.length>0?a.sort((e,t)=>e.w-t.w):o.map(e=>({url:e.url,w:0})),u=c(d[0].url),h=c(d[d.length-1].url);return l||(l=c(n||d[Math.floor(d.length/2)].url)),{lowQuality:u,mediumQuality:l,highQuality:h}};class u{isRunning;updateInterval;renderInterval;productDetector;attentionEngine;tracker;constructor(e,t){this.tracker=e,this.productDetector=t,this.attentionEngine=new r,this.isRunning=!1,this.updateInterval=null,this.renderInterval=null}start(){if(this.isRunning)return console.warn(t+"Attention Detector is already running!"),this;this.productDetector.init(),this.attentionEngine.visibilityEngine.updateViewportOnResize(),this.attentionEngine.visibilityEngine.setupScrollDirectionTracking(),this.attentionEngine.visibilityEngine.setupInactivityDetection(),this.updateInterval=setInterval(()=>{const e=this.productDetector.getAllProducts();this.attentionEngine.update(e),this.productDetector.cleanupStaleProducts()},i.scrollThrottle);const e=s.throttle(()=>{const e=this.productDetector.getAllProducts();this.attentionEngine.update(e)},i.scrollThrottle);return window.addEventListener("scroll",e,{passive:!0}),document.addEventListener("scroll",e,{passive:!0,capture:!0}),this.isRunning=!0,this}stop(){return this.isRunning?(this.updateInterval&&clearInterval(this.updateInterval),this.renderInterval&&clearInterval(this.renderInterval),this.isRunning=!1,this):this}pause(){return this.attentionEngine.visibilityEngine.isPaused?(console.warn(t+"Attention Detector is already paused!"),this):(this.attentionEngine.visibilityEngine.isPaused=!0,this)}resume(){return this.attentionEngine.visibilityEngine.isPaused?(this.attentionEngine.visibilityEngine.isPaused=!1,this):(console.warn(t+"Attention Detector is already running!"),this)}exportData(){return{timestamp:Date.now(),contemplating:this.attentionEngine.getContemplatingProducts().map(e=>({url:e.url,visibility:e.visibility,totalDwellTime:e.totalDwellTime+(e.dwellStartTime?Date.now()-e.dwellStartTime:0),viewCount:e.viewCount,firstSeen:e.firstSeen})),allProducts:this.attentionEngine.getAllAttentionData().map(e=>({url:e.url,wasContemplated:e.wasContemplated,totalDwellTime:e.totalDwellTime,viewCount:e.viewCount,firstSeen:e.firstSeen,lastVisibilityChange:e.lastVisibilityChange}))}}exportSnapshotData(){const e=Date.now();return this.attentionEngine.getAllAttentionData().filter(e=>e.viewCount>0).map(t=>{const i=new URL(t.url,window.location.origin),s=i.pathname.split("/").filter(Boolean),n=a(s,["products"]);let r=t.totalDwellTime;return t.isVisible&&t.dwellStartTime&&(r+=e-t.dwellStartTime),{is_variant:i.searchParams.has("variant"),url_full:i.href,url_path_all:s,url_path_full:t.url,url_parameters_product_variant:i.searchParams.get("variant"),url_path_product_name:n,image_small_url:d(t.product.image)?.lowQuality||null,image_medium_url:d(t.product.image)?.mediumQuality||null,image_large_url:d(t.product.image)?.highQuality||null,first_seen:t.firstSeen,last_seen:t.lastVisibilityChange,view_count:t.viewCount,total_dwell_time:r}})}getContemplating(){return this.attentionEngine.getContemplatingProducts()}reset(){return this.attentionEngine.reset(),this}destroy(){this.stop(),this.productDetector.destroy(),this.tracker?.debugManager?.attentionDebugPanel?.destroy(),console.log(t+"üí• Attention Detector destroyed")}updateConfig(e){return Object.assign(i,e),console.log(t+"‚öôÔ∏è Attention Detector config updated: ",e),this}}class h{products;observer;linkIds;nextProductId;constructor(){this.products=new Map,this.observer=null,this.linkIds=new WeakMap,this.nextProductId=0}init(){return this.scanForProducts(),this.observeDOMMutations(),this}getCurrentVisibleImage(e){const t=e.querySelectorAll("img");for(const e of t)if(s.isElementEffectivelyVisible(e))return e;return null}scanForProducts(){const e=document.querySelectorAll("a[href]");Array.from(e).filter(e=>{const t=e.getAttribute("href")||"";return/^\/([^/]+\/)?products\//i.test(t)}).forEach(e=>{const t=e.getAttribute("href"),i=s.normalizeProductUrl(t);if(!i)return;const n=this.getCurrentVisibleImage(e);if(!n)return;let r=this.linkIds.get(e);if(r||(this.nextProductId+=1,r=`product-${this.nextProductId}`,this.linkIds.set(e,r)),this.products.has(r)){const e=this.products.get(r);e.url=i,e.image=n,e.lastSeen=Date.now()}else this.products.set(r,{id:r,url:i,element:e,image:n,lastSeen:Date.now()})})}observeDOMMutations(){const e=s.debounce(()=>{this.scanForProducts()},i.mutationDebounce);this.observer=new MutationObserver(t=>{let i=!1;for(const e of t){if(e.addedNodes.length>0||e.removedNodes.length>0){i=!0;break}if("attributes"===e.type){i=!0;break}}i&&e()}),this.observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]})}cleanupStaleProducts(){const e=Date.now();for(const[t,i]of this.products.entries())document.body.contains(i.element)?i.lastSeen=e:e-i.lastSeen>5e3&&this.products.delete(t)}getAllProducts(){for(const[e,t]of this.products.entries()){const e=this.getCurrentVisibleImage(t.element);e&&(t.image=e)}return Array.from(this.products.values())}getAllProductsCount(){return this.products.size}destroy(){this.observer&&this.observer.disconnect(),this.products.clear()}}class g{constructor(){}setCookie(e,t,i={}){if("undefined"==typeof document)return;const{maxAgeSeconds:s,path:n="/",domain:r,secure:o=!0,sameSite:a="strict"}=i;let l=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;null!=s&&(l+=`; max-age=${s}`),n&&(l+=`; path=${n}`),r&&(l+=`; domain=${r}`),o&&(l+="; secure"),a&&(l+=`; samesite=${a}`),document.cookie=l}getCookie(e){const t=document.cookie.split("; ").find(t=>t.startsWith(e+"="));return t?decodeURIComponent(t.split("=").slice(1).join("=")):null}}class p{sessionID;sessionInitTime;sessionRecordTime;storageKey="medianth_session";constructor(){this.sessionID=this.getSessionID(),this.sessionRecordTime=Date.now(),this.sessionInitTime=Number(this.sessionID.split("-")[0])}getSessionID(){let e=sessionStorage.getItem(this.storageKey);return e||(e=this.generateSessionID(),sessionStorage.setItem(this.storageKey,e)),e}generateSessionID(){return`${Date.now()}-${Math.random().toString(36).substring(2,11)}`}getSessionDuration(){return Date.now()-this.sessionRecordTime}createSession(){this.sessionID=this.generateSessionID(),this.sessionRecordTime=Date.now(),sessionStorage.setItem(this.storageKey,this.sessionID)}renewSession(){this.sessionRecordTime=Date.now()}}class m{sessionManager;productDetector;attentionDetector;clickDetector;constructor(e,t,i,s){this.sessionManager=e,this.productDetector=t,this.attentionDetector=i,this.clickDetector=s}buildPageSnapshot=e=>{const{url:t,urlPaths:i,urlParamsAll:s,urlIsProductPage:n,urlIsCollectionPage:r,productName:a,collectionName:c}=l(window.location.href),{url:d,urlPaths:u,urlParamsAll:h,urlIsProductPage:g,urlIsCollectionPage:p,productName:m,collectionName:b}=l(document.referrer),v=new Set(["utm_source","utm_medium","utm_campaign","utm_term","utm_content"]),f=new Set(["gclid","gclsrc","dclid","wbraid","gbraid","fbclid","msclkid","twclid","li_fat_id","mc_cid","igshid","ttclid"]),y=Date.now(),w={session_id:this.sessionManager.sessionID,session_init_time:this.sessionManager.sessionInitTime,snapshot_reason:e,snapshot_timestamp:y,title:document.title,viewport_width:window.innerWidth,viewport_height:window.innerHeight,user_agent:navigator.userAgent,is_product_page:n,is_product_variant:t&&t.searchParams.has("variant"),is_collection_page:r,referrer_is_product_page:g,referrer_is_product_variant:d&&d.searchParams.has("variant"),referrer_is_same_product_page_but_different_variant:d&&t&&d.pathname===t.pathname&&d.searchParams.get("variant")!==t.searchParams.get("variant"),referrer_is_collection_page:p,referrer_url_full:d&&d.href,referrer_url_origin:d&&d.origin,referrer_url_protocol:d&&d.protocol,referrer_url_hostname:d&&d.hostname,referrer_url_path_full:d&&d.pathname,referrer_url_path_all:u,referrer_url_parameters_all:h,referrer_url_parameters_utm:h&&h.filter(e=>v.has(e.key)),referrer_url_parameters_ads:h&&h.filter(e=>f.has(e.key)),referrer_url_parameters_product_variant:d&&(d.searchParams.get("variant")??void 0),referrer_url_path_product_name:m,referrer_url_path_collection_name:b,url_full:t&&t.href,url_origin:t&&t.origin,url_protocol:t&&t.protocol,url_hostname:t&&t.hostname,url_path_full:t&&t.pathname,url_path_all:i,url_parameters_all:s,url_parameters_utm:s&&s.filter(e=>v.has(e.key)),url_parameters_ads:s&&s.filter(e=>f.has(e.key)),url_parameters_product_variant:t&&(t.searchParams.get("variant")??void 0),url_path_product_name:a,url_path_collection_name:c,product_detector_total_products:this.productDetector.getAllProductsCount()};return sessionStorage.setItem("medianth_page_snapshot_timestamp",y.toString()),o(w)};buildSessionSnapshot=e=>{const t=sessionStorage.getItem("medianth_page_snapshot_timestamp");if(null===t||Number.isNaN(Number(t)))return;const i=this.clickDetector.exportSnapshotData(),s={session_id:this.sessionManager.sessionID,session_init_time:this.sessionManager.sessionInitTime,page_snapshot_timestamp:Number(t),snapshot_timestamp:Date.now(),snapshot_reason:e,session_duration:this.sessionManager.getSessionDuration(),session_record_time:this.sessionManager.sessionRecordTime,attention_detector_products:this.attentionDetector.exportSnapshotData(),rage_clicks_count:i.rageClicks.count,rage_clicks_burstiness:i.rageClicks.burstiness,rage_clicks_repeat_rate:i.rageClicks.repeatRate,rage_clicks_entropy:i.rageClicks.entropy,dead_clicks_count:i.deadClicks.count,dead_clicks_burstiness:i.deadClicks.burstiness,dead_clicks_repeat_rate:i.deadClicks.repeatRate,dead_clicks_entropy:i.deadClicks.entropy};return"debug"!==e&&(this.attentionDetector.reset(),this.sessionManager.renewSession()),o(s)}}class b{tracker;streamURL;retryQueue=[];maxRetries=3;constructor(e,t){this.tracker=e,this.streamURL=t}async sendData(e,i){try{const t=await fetch(this.streamURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0});if(!t.ok)throw new Error(`HTTP ${t.status}`)}catch(i){const s=new Date,n=`${s.toLocaleDateString("en-GB")} - ${s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit"})}`;this.tracker.config.debug&&console.log(t+"Failed to send snapshot ("+n+"): ",i),this.queueForRetry(e)}}sendPageSnapshot=async e=>{const i={topic:"PAGE_SNAPSHOT",message:JSON.stringify(e)};this.tracker.config.debug&&console.log(t+"TRANSPORTING: Page Snapshot: ",e),await this.sendData(i,"page_snapshot")};sendSessionSnapshot=async e=>{const i={topic:"SESSION_SNAPSHOT",message:JSON.stringify(e)};this.tracker.config.debug&&console.log(t+"TRANSPORTING: Session Snapshot: ",e),await this.sendData(i,"session_snapshot")};queueForRetry(e){this.retryQueue.push({data:e,retries:0}),this.processRetryQueue()}async processRetryQueue(){if(0===this.retryQueue.length)return;const e=this.retryQueue.shift();if(e)if(e.retries>=this.maxRetries)console.error(t+"Max retries reached, dropping event.");else try{console.warn(t+"Retrying to send snapshot... ("+(e.retries+1)+")");const i=await fetch(this.streamURL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e.data),keepalive:!0});if(!i.ok)throw new Error(`HTTP ${i.status}`)}catch(t){e.retries++,this.retryQueue.push(e),setTimeout(()=>{this.processRetryQueue()},1e3*Math.pow(2,e.retries))}}flushQueue(){for(;this.retryQueue.length>0;)this.processRetryQueue()}}class v{attentionEngine;debugPanel=null;viewportOverlay=null;isDragging=!1;dragOffsetX=0;dragOffsetY=0;isCollapsed=!1;contentContainer=null;collapsedMiniView=null;header=null;renderInterval=null;constructor(e){this.attentionEngine=e,this.loadDebugPanelState(),this.renderInterval=setInterval(()=>{this.render()},i.renderThrottle)}loadDebugPanelState(){try{const e=localStorage.getItem("medianth_debug_panel_state");if(e){const t=JSON.parse(e);this.isCollapsed=t.isCollapsed||!1}}catch(e){}}saveDebugPanelState(){try{if(localStorage.setItem("medianth_debug_panel_state",JSON.stringify({isCollapsed:this.isCollapsed})),this.debugPanel){const e={top:this.debugPanel.style.top,right:this.debugPanel.style.right,left:this.debugPanel.style.left};localStorage.setItem("medianth_debug_panel_position",JSON.stringify(e))}}catch(e){}}loadDebugPanelPosition(){try{const e=localStorage.getItem("medianth_debug_panel_position");if(e)return JSON.parse(e)}catch(e){}return null}initDebugPanel(){this.viewportOverlay=document.createElement("div"),this.viewportOverlay.id="shopify-attention-viewport-overlay",this.viewportOverlay.style.cssText="\n            position: fixed;\n            left: 0;\n            right: 0;\n            display: block;\n            background: rgba(255, 0, 0, 0.15);\n            border-top: 3px solid rgba(255, 0, 0, 0.8);\n            border-bottom: 3px solid rgba(255, 0, 0, 0.8);\n            pointer-events: none;\n            z-index: 2147483647;\n            transition: top 0.1s, height 0.1s;\n        ";const e=this.attentionEngine.visibilityEngine.attentionViewport;this.viewportOverlay.style.top=`${e.top}px`,this.viewportOverlay.style.height=`${e.height}px`,document.body.insertBefore(this.viewportOverlay,document.body.firstChild),window.addEventListener("resize",()=>{const e=this.attentionEngine.visibilityEngine.attentionViewport;this.viewportOverlay.style.top=`${e.top}px`,this.viewportOverlay.style.height=`${e.height}px`}),this.debugPanel=document.createElement("div"),this.debugPanel.id="shopify-attention-tracker-debug",this.debugPanel.style.cssText='\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            width: 350px;\n            max-height: 80vh;\n            overflow-y: auto;\n            background: rgba(0, 0, 0, 0.95);\n            color: #00ff00;\n            font-family: "Courier New", monospace;\n            font-size: 12px;\n            padding: 15px;\n            border-radius: 8px;\n            z-index: 2147483646;\n            box-shadow: 0 4px 20px rgba(0, 255, 0, 0.3);\n            border: 2px solid #00ff00;\n            user-select: none;\n        ';const t=this.loadDebugPanelPosition();t&&(t.top&&(this.debugPanel.style.top=t.top),t.right&&(this.debugPanel.style.right=t.right),t.left&&(this.debugPanel.style.left=t.left)),document.body.insertBefore(this.debugPanel,document.body.firstChild);const i=document.createElement("div");this.header=i,i.style.cssText=`\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: ${this.isCollapsed?"0":"15px"};\n            padding-bottom: 10px;\n            border-bottom: ${this.isCollapsed?"none":"2px solid #00ff00"};\n            cursor: grab;\n            user-select: none;\n        `,i.onmousedown=e=>this.startDrag(e);const s=document.createElement("h3");s.textContent="üìä ATTENTION TRACKER",s.style.cssText=`\n            margin: 0;\n            color: #00ff00;\n            font-size: 14px;\n            flex-grow: 1;\n            pointer-events: none;\n            display: ${this.isCollapsed?"none":"block"};\n        `,i.appendChild(s),this.collapsedMiniView=document.createElement("div"),this.collapsedMiniView.style.cssText=`\n            font-size: 12px;\n            color: #00ff00;\n            line-height: 1;\n            flex-grow: 1;\n            pointer-events: none;\n            display: ${this.isCollapsed?"flex":"none"};\n            gap: 15px;\n            align-items: center;\n        `,i.appendChild(this.collapsedMiniView);const n=document.createElement("div");n.style.cssText="\n            display: flex;\n            gap: 5px;\n            align-items: center;\n        ";const r=document.createElement("button");r.style.cssText="\n            background: none;\n            border: none;\n            color: #00ff00;\n            font-size: 16px;\n            cursor: pointer;\n            padding: 0 5px;\n            line-height: 1;\n        ",r.textContent=this.isCollapsed?"‚ñ∂":"‚ñº",r.onclick=e=>{e.stopPropagation(),this.toggleCollapse(),r.textContent=this.isCollapsed?"‚ñ∂":"‚ñº",s.style.display=this.isCollapsed?"none":"block",this.collapsedMiniView.style.display=this.isCollapsed?"flex":"none"},n.appendChild(r);const o=document.createElement("button");o.textContent="√ó",o.style.cssText="\n            background: none;\n            border: none;\n            color: #00ff00;\n            font-size: 20px;\n            cursor: pointer;\n            padding: 0;\n            line-height: 1;\n        ",o.onclick=e=>{e.stopPropagation(),this.hideDebugPanel()},n.appendChild(o),i.appendChild(n),this.debugPanel.appendChild(i),this.contentContainer=document.createElement("div"),this.contentContainer.style.cssText="\n            max-height: calc(80vh - 60px);\n            overflow-y: auto;\n            transition: all 0.3s ease;\n        ",this.isCollapsed&&(this.contentContainer.style.display="none"),this.debugPanel.appendChild(this.contentContainer),document.addEventListener("mousemove",e=>this.drag(e)),document.addEventListener("mouseup",()=>this.stopDrag())}startDrag(e){if(!this.debugPanel)return;this.isDragging=!0;const t=this.debugPanel.getBoundingClientRect();this.dragOffsetX=e.clientX-t.left,this.dragOffsetY=e.clientY-t.top,this.debugPanel.style.cursor="grabbing"}drag(e){if(!this.isDragging||!this.debugPanel)return;const t=e.clientX-this.dragOffsetX,i=e.clientY-this.dragOffsetY;this.debugPanel.style.right="auto",this.debugPanel.style.top=Math.max(0,i)+"px",this.debugPanel.style.left=Math.max(0,t)+"px"}stopDrag(){this.isDragging=!1,this.debugPanel&&(this.debugPanel.style.cursor="grab",this.saveDebugPanelState())}toggleCollapse(){this.isCollapsed=!this.isCollapsed,this.contentContainer&&(this.contentContainer.style.display=this.isCollapsed?"none":"block"),this.collapsedMiniView&&(this.collapsedMiniView.style.display=this.isCollapsed?"block":"none"),this.header&&(this.header.style.marginBottom=this.isCollapsed?"0":"15px",this.header.style.borderBottom=this.isCollapsed?"none":"2px solid #00ff00"),this.saveDebugPanelState()}render(){if(this.debugPanel||this.initDebugPanel(),!this.contentContainer)return;const e=this.attentionEngine.getContemplatingProducts(),t=this.attentionEngine.getAllAttentionData(),s=this.attentionEngine.visibilityEngine.scrollDirection.toUpperCase(),n="DOWN"===s?"‚Üì":"‚Üë",r=this.attentionEngine.visibilityEngine.hasUserEngaged,o=this.attentionEngine.visibilityEngine.isPaused;let a,l;r?o?(a="‚è∏Ô∏è PAUSED (inactive/background)",l="#ff6b6b"):(a=`Scroll: ${n} ${s}`,l="#0f0"):(a="‚è∏Ô∏è Waiting for engagement...",l="#888");let c=`\n            <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 0, 0.1); border-radius: 4px;">\n            <strong>Currently Contemplating: ${e.length}</strong><br>\n            <span style="color: #888;">Total Tracked: ${t.length}</span><br>\n            <span style="color: ${l}; font-weight: bold;">\n                ${a}\n            </span>\n            </div>\n        `;0===e.length?c+='<p style="color: #888; font-style: italic;">No products being contemplated...</p>':e.forEach((e,t)=>{const i=e.currentSessionDwell||0,s=e.totalDwellTime+i;c+=`\n                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 0, 0.15); border-left: 3px solid #00ff00; border-radius: 4px;">\n                    <div style="font-weight: bold; margin-bottom: 5px; color: #00ff00;">\n                        üéØ Product ${t+1}\n                    </div>\n                    <div style="font-size: 10px; color: #0f0; margin-bottom: 8px; word-break: break-all;">\n                        ${e.url}\n                    </div>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px;">\n                        <div><span style="color: #888;">Visibility:</span> ${(100*e.visibility).toFixed(0)}%</div>\n                        <div><span style="color: #888;">Views:</span> ${e.viewCount}</div>\n                        <div><span style="color: #888;">Total:</span> ${(s/1e3).toFixed(1)}s</div>\n                        <div><span style="color: #888;">Session:</span> ${(i/1e3).toFixed(1)}s</div>\n                    </div>\n                    </div>\n                `});const d=t.filter(e=>e.isVisible).length,u=t.filter(e=>e.wasContemplated).length;if(c+=`\n            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #00ff00; font-size: 11px; color: #888;">\n            <div>Visible Now: ${d}</div>\n            <div>Total Contemplated (session): ${u}</div>\n            <div>Viewport: ${100*i.attentionViewport.topExclusion}%-${100*(1-i.attentionViewport.bottomExclusion)}%</div>\n            </div>\n        `,this.contentContainer.innerHTML=c,this.collapsedMiniView){const i=`\n                <span style="color: ${o?"#ff6b6b":"#00ff00"};">${r?o?"‚è∏Ô∏è":"‚ñ∂Ô∏è":"‚è≥"}</span>\n                <span>üì¶ ${t.length}</span>\n                <span>üéØ ${e.length}</span>\n            `;this.collapsedMiniView.innerHTML=i}}showDebugPanel(){this.debugPanel&&(this.debugPanel.style.display="block"),this.viewportOverlay&&(this.viewportOverlay.style.display="block")}hideDebugPanel(){this.debugPanel&&(this.debugPanel.style.display="none"),this.viewportOverlay&&(this.viewportOverlay.style.display="none")}destroy(){this.renderInterval&&(clearInterval(this.renderInterval),this.renderInterval=null),this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.viewportOverlay&&(this.viewportOverlay.remove(),this.viewportOverlay=null),this.contentContainer=null,this.collapsedMiniView=null,this.header=null}}class f{debugPanel=null;tracker;isDebugEnabled;attentionDebugPanel=null;constructor(e,t){this.tracker=e,this.isDebugEnabled=t,this.isDebugEnabled&&(this.initMainDebugPanel(),this.registerDebugPanels())}initMainDebugPanel(){this.debugPanel=document.createElement("div"),this.debugPanel.id="medianth-debug-buttons",this.debugPanel.style.cssText="\n            position: fixed;\n            left: 0;\n            bottom: 0;\n            z-index: 2147483647;\n            display: flex;\n            gap: 8px;\n        ",document.body.insertBefore(this.debugPanel,document.body.firstChild);const e="\n            all: unset;\n            background-color: white;\n            cursor: pointer;\n            color: black;\n            border: 1px solid black;\n            font-family: sans-serif;\n            padding: 5px 15px;\n        ",t=document.createElement("button");t.textContent="Snapshot: Page",t.style.cssText=e,t.onclick=()=>this.tracker.debugPageSnapshot(),this.debugPanel.appendChild(t);const i=document.createElement("button");i.textContent="Snapshot: Session",i.style.cssText=e,i.onclick=()=>this.tracker.debugSessionSnapshot(),this.debugPanel.appendChild(i)}registerDebugPanels(){this.isDebugEnabled&&(this.attentionDebugPanel=new v(this.tracker.attentionDetector.attentionEngine))}showDebugPanels(){this.debugPanel&&(this.debugPanel.style.display="block"),this.attentionDebugPanel?.showDebugPanel()}hideDebugPanels(){this.debugPanel&&(this.debugPanel.style.display="none"),this.attentionDebugPanel?.hideDebugPanel()}showDebugPanel(){this.showDebugPanels()}hideDebugPanel(){this.hideDebugPanels()}destroy(){this.debugPanel&&(this.debugPanel.remove(),this.debugPanel=null),this.attentionDebugPanel?.destroy(),this.attentionDebugPanel=null}}class y{static MAX_BODY_LENGTH=300;static inspect(e){if(!(e&&e instanceof Element))return{tag:"unknown"};const t={tag:e.tagName.toLowerCase()},i=e.textContent?.trim()||"",s=e.innerHTML?.trim()||"";if(s.length>0||i.length>0){const e=s||i,n=this.isCodeContent(e);t.body=e.substring(0,this.MAX_BODY_LENGTH),t.bodyType=n?"code":"text"}return t}static isCodeContent(e){return[/function\s*\(/,/const\s+\w+\s*=/,/let\s+\w+\s*=/,/var\s+\w+\s*=/,/=>\s*{/,/import\s+.*from/,/export\s+(default|const|function|class)/,/<script[^>]*>/i,/<style[^>]*>/i,/<[a-z][\s\S]*?>/i,/\{[\s\S]*:\s*[\s\S]*\}/,/if\s*\(/,/for\s*\(/,/while\s*\(/].some(t=>t.test(e))}static detectAutofill(e){try{const t=window.getComputedStyle(e,":-webkit-autofill").length>0,i=(e.hasAttribute("autocomplete")&&e.getAttribute("autocomplete"),e.matches(":-webkit-autofill")||e.matches(":autofill"));return t||i}catch(e){return!1}}static getFormElements(e){const t=[],i=["text","password","email","number","tel","url","search"];for(let s=0;s<e.elements.length;s++){const n=e.elements[s];(n instanceof HTMLInputElement&&i.includes(n.type)||n instanceof HTMLTextAreaElement)&&t.push(n)}return t}}const w={rageClickMinClicks:3,rageClickTimeWindow:250,deadClickTimeout:2e3,fastScrollMinDistance:400,fastScrollMaxTime:200,rageScrollMinCount:3,rageScrollTimeWindow:2e3,fastCursorMinDistance:120,fastCursorMaxTime:300,fastCursorMinSpeed:1};class C{thresholds;rageClicksData={count:0,burstiness:0,repeatRate:0,entropy:0};deadClicksData={count:0,burstiness:0,repeatRate:0,entropy:0};currentRageSession=[];lastClickTimestamp=0;rageClickElementCounts=new Map;rageClickTimestamps=[];rageClickPositions=[];deadClickElementCounts=new Map;deadClickTimestamps=[];deadClickPositions=[];pendingClick=null;boundHandleClick;rageSessionTimeout=null;constructor(){this.thresholds=w,this.boundHandleClick=this.handleClick.bind(this),this.attachListeners()}attachListeners(){document.addEventListener("click",this.boundHandleClick,!0)}handleClick(e){const t=Date.now(),i=e.target,s=y.inspect(i),n={timestamp:t,x:e.clientX,y:e.clientY,elementTag:s.tag,elementBody:s.body,elementBodyType:s.bodyType,isDead:!0};this.pendingClick&&(this.pendingClick.observer&&this.pendingClick.observer.disconnect(),this.pendingClick.timer&&clearTimeout(this.pendingClick.timer),this.aggregateDeadClick(this.pendingClick.event)),this.processClickForRageDetection(n);const r=new MutationObserver(()=>{r.disconnect(),this.pendingClick?.timer&&clearTimeout(this.pendingClick.timer),n.isDead=!1,this.pendingClick=null});r.observe(document.body,{childList:!0,subtree:!0,attributes:!0,characterData:!0});const o=window.setTimeout(()=>{r.disconnect(),n.isDead=!0,this.pendingClick=null,this.aggregateDeadClick(n)},this.thresholds.deadClickTimeout);this.pendingClick={event:n,observer:r,timer:o}}processClickForRageDetection(e){this.rageSessionTimeout&&clearTimeout(this.rageSessionTimeout),this.lastClickTimestamp>0&&e.timestamp-this.lastClickTimestamp<=this.thresholds.rageClickTimeWindow?this.currentRageSession.push(e):(this.currentRageSession.length>=this.thresholds.rageClickMinClicks&&this.aggregateRageClickSession(this.currentRageSession),this.currentRageSession=[e]),this.lastClickTimestamp=e.timestamp,this.rageSessionTimeout=window.setTimeout(()=>{this.currentRageSession.length>=this.thresholds.rageClickMinClicks&&this.aggregateRageClickSession(this.currentRageSession),this.currentRageSession=[],this.rageSessionTimeout=null},this.thresholds.rageClickTimeWindow)}aggregateRageClickSession(e){if(this.rageClicksData.count+=e.length,e.forEach(e=>{this.rageClickTimestamps.push(e.timestamp),this.rageClickPositions.push({x:e.x,y:e.y})}),this.rageClickTimestamps.length>1e3&&(this.rageClickTimestamps=this.rageClickTimestamps.slice(-1e3),this.rageClickPositions=this.rageClickPositions.slice(-1e3)),e.forEach(e=>{const t=`${e.elementTag}-${e.elementBody||""}`;this.rageClickElementCounts.set(t,(this.rageClickElementCounts.get(t)||0)+1)}),this.rageClickElementCounts.size>100){const e=Array.from(this.rageClickElementCounts.entries()).sort((e,t)=>t[1]-e[1]).slice(0,100);this.rageClickElementCounts=new Map(e)}this.updateRageClicksPattern(),e.length=0}calculateSpatialEntropy(e){if(e.length<2)return 0;const t=new Map;e.forEach(e=>{const i=`${Math.floor(e.x/100)},${Math.floor(e.y/100)}`;t.set(i,(t.get(i)||0)+1)});const i=e.length;let s=0;t.forEach(e=>{const t=e/i;t>0&&(s-=t*Math.log2(t))});const n=Math.log2(t.size);return n>0?s/n:0}updateRageClicksPattern(){if(0===this.rageClicksData.count)return;const e=this.rageClicksData.count;let t=0;if(this.rageClickElementCounts.forEach(e=>{e>t&&(t=e)}),this.rageClicksData.repeatRate=t/e,this.rageClicksData.entropy=this.calculateSpatialEntropy(this.rageClickPositions),this.rageClickTimestamps.length>=2){const e=[];for(let t=1;t<this.rageClickTimestamps.length;t++)e.push(this.rageClickTimestamps[t]-this.rageClickTimestamps[t-1]);const t=e.reduce((e,t)=>e+t,0)/e.length,i=e.reduce((e,i)=>e+Math.pow(i-t,2),0)/e.length,s=Math.sqrt(i),n=t>0?s/t:0;this.rageClicksData.burstiness=Math.min(n/2,1)}else this.rageClicksData.burstiness=0}aggregateDeadClick(e){this.deadClicksData.count++,this.deadClickTimestamps.push(e.timestamp),this.deadClickPositions.push({x:e.x,y:e.y}),this.deadClickTimestamps.length>1e3&&(this.deadClickTimestamps=this.deadClickTimestamps.slice(-1e3),this.deadClickPositions=this.deadClickPositions.slice(-1e3));const t=`${e.elementTag}-${e.elementBody||""}`;if(this.deadClickElementCounts.set(t,(this.deadClickElementCounts.get(t)||0)+1),this.deadClickElementCounts.size>100){const e=Array.from(this.deadClickElementCounts.entries()).sort((e,t)=>t[1]-e[1]).slice(0,100);this.deadClickElementCounts=new Map(e)}this.updateDeadClicksPattern()}updateDeadClicksPattern(){if(0===this.deadClicksData.count)return;const e=this.deadClicksData.count;let t=0;if(this.deadClickElementCounts.forEach(e=>{e>t&&(t=e)}),this.deadClicksData.repeatRate=t/e,this.deadClicksData.entropy=this.calculateSpatialEntropy(this.deadClickPositions),this.deadClickTimestamps.length>=2){const e=[];for(let t=1;t<this.deadClickTimestamps.length;t++)e.push(this.deadClickTimestamps[t]-this.deadClickTimestamps[t-1]);const t=e.reduce((e,t)=>e+t,0)/e.length,i=e.reduce((e,i)=>e+Math.pow(i-t,2),0)/e.length,s=Math.sqrt(i),n=t>0?s/t:0;this.deadClicksData.burstiness=Math.min(n/2,1)}else this.deadClicksData.burstiness=0}exportSnapshotData=()=>({rageClicks:{count:this.rageClicksData.count,burstiness:this.rageClicksData.burstiness,repeatRate:this.rageClicksData.repeatRate,entropy:this.rageClicksData.entropy},deadClicks:{count:this.deadClicksData.count,burstiness:this.deadClicksData.burstiness,repeatRate:this.deadClicksData.repeatRate,entropy:this.deadClicksData.entropy}});reset(){this.pendingClick&&(this.pendingClick.observer&&this.pendingClick.observer.disconnect(),this.pendingClick.timer&&clearTimeout(this.pendingClick.timer),this.pendingClick=null),this.rageSessionTimeout&&(clearTimeout(this.rageSessionTimeout),this.rageSessionTimeout=null),this.rageClicksData={count:0,burstiness:0,repeatRate:0,entropy:0},this.deadClicksData={count:0,burstiness:0,repeatRate:0,entropy:0},this.currentRageSession=[],this.lastClickTimestamp=0,this.rageClickElementCounts.clear(),this.rageClickTimestamps=[],this.rageClickPositions=[],this.deadClickElementCounts.clear(),this.deadClickTimestamps=[],this.deadClickPositions=[]}destroy(){document.removeEventListener("click",this.boundHandleClick,!0),this.reset()}}class k{initialized=!1;transport;config;sessionManager;snapshotBuilder;cookieManager;debugManager;productDetector;attentionDetector;clickDetector;constructor(e){this.config=e,this.validateConfig(),this.cookieManager=new g,this.sessionManager=new p,this.productDetector=new h,this.attentionDetector=new u(this,this.productDetector),this.clickDetector=new C,this.snapshotBuilder=new m(this.sessionManager,this.productDetector,this.attentionDetector,this.clickDetector),this.transport=new b(this,e.streamURL),this.debugManager=new f(this,e.debug??!1),this.initialize(e)}validateConfig(){if(!this.config.streamURL)throw new Error(t+"streamURL is required")}async initialize(e){this.initialized||(sessionStorage.getItem("medianth_page_snapshot_timestamp")?this.sendPageSnapshot("navigation"):this.sendPageSnapshot("init"),this.attentionDetector.start(),this.attachUnloadListeners(),this.initialized=!0,this.config.debug&&console.log(t+"Tracker initialized: ",{streamURL:this.config.streamURL,sessionID:this.sessionManager.sessionID}))}attachUnloadListeners(){let e=location.pathname;new MutationObserver(()=>{location.pathname!==e&&(e=location.pathname,this.handleSessionUnload("spanavigation"),this.sendPageSnapshot("navigation"))}).observe(document.body,{childList:!0,subtree:!0}),window.addEventListener("beforeunload",()=>{this.handleSessionUnload("beforeunload")}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.handleSessionUnload("visibilitychange")}),window.addEventListener("pagehide",()=>{this.handleSessionUnload("pagehide")})}handleSessionUnload=e=>{this.config.debug&&console.log(t+"Sending session snapshot on unload...");const i=this.snapshotBuilder.buildSessionSnapshot(e);i&&("debug"!==e&&(this.attentionDetector.reset(),this.sessionManager.renewSession(),this.attentionDetector.pause()),this.transport.sendSessionSnapshot(i),this.transport.flushQueue())};sendPageSnapshot=e=>{const t=this.snapshotBuilder.buildPageSnapshot(e);this.transport.sendPageSnapshot(t)};reInitialize(){this.config.debug&&console.warn(t+"Reinitializing..."),this.sessionManager.createSession(),this.clickDetector.reset()}destroy(){this.config.debug&&console.warn(t+"Destroying tracker..."),this.debugManager&&(this.debugManager.destroy(),this.debugManager=null),this.clickDetector.destroy(),this.initialized=!1}debugSessionSnapshot(){if(!this.config.debug)return;const e=this.snapshotBuilder.buildSessionSnapshot("debug");console.log(t+"Session Snapshot: ",e)}debugPageSnapshot(){if(!this.config.debug)return;const e=this.snapshotBuilder.buildPageSnapshot("debug");console.log(t+"Page Snapshot: ",e)}}let S=null;const P=document.currentScript;function D(){const e=P;if(!e)return void console.error(t+"Could not find script tag");const i=e.getAttribute("streamURL");if(!i)return void console.error(t+"Missing required attributes: initURL, streamURL");const s={streamURL:i,debug:"true"===e.getAttribute("debug")};try{S=new k(s),window.medianth.tracker=S}catch(e){console.error(t+"Initialization failed: ",e)}}return"undefined"!=typeof window&&(window.medianth={tracker:null,reInitialize:()=>S?.reInitialize(),destroy:()=>S?.destroy(),debugSessionSnapshot:()=>S?.debugSessionSnapshot(),debugPageSnapshot:()=>S?.debugPageSnapshot()}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",D):D(),e.MedianthTracker=k,e.consoleIcon=t,e}({});
